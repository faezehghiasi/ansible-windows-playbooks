
- name: Ensure Windows Update service is running and set to automatic
  win_service:
    name: wuauserv
    state: started
    start_mode: auto

- name: Configure Windows Update automatic updates via registry
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: "{{ item.name }}"
    data: "{{ item.value }}"
    type: dword
  loop:
    - { name: "NoAutoUpdate", value: 0 }
    - { name: "AUOptions", value: 4 }
    - { name: "ScheduledInstallDay", value: 0 }
    - { name: "ScheduledInstallTime", value: 3 }

- name: Create Windows Update scan scheduled task
  win_scheduled_task:
    name: "Custom Windows Update Scan"
    description: "Automatically scan for Windows updates weekly"
    state: present
    enabled: yes
    author: "System Administrator"
    triggers:
      - type: weekly
        start_boundary: "2025-01-01T03:00:00"
        days_of_week: ["sunday"]
    actions:
      - path: "C:/Windows/System32/UsoClient.exe"
        arguments: "StartScan"
    settings:
      enabled: yes
      run_only_if_network_available: yes
      wake_to_run: no
